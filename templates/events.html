{% extends "base.html" %}
{% set season_param = request.args.get('season') %}
{% block body %}

<form method="get" action="{{ url_for('events_log') }}" class="totals filter-form events-filters" style="margin-bottom:12px;">
  {% if season_param %}
    <input type="hidden" name="season" value="{{ season_param }}">
  {% endif %}
  <div class="filter-inline-toggle">
    {% if default_player %}
      {% set me_active = request.args.get('me') == '1' %}
      <a class="btn icon emoji-toggle{% if me_active %} active{% endif %}"
         href="{{ url_for('events_log',
           season=season_param,
           me=None if me_active else 1,
           cup=selected_filters.cup,
           track=selected_filters.track,
           event_type=selected_filters.event_type,
           player=selected_filters.player) }}"
         aria-pressed="{{ 'true' if me_active else 'false' }}">üë§</a>
    {% endif %}
    <label>
      {{ _("Player") }}
      <select name="player">
      <option value="">{{ _("All players") }}</option>
      {% for p in players %}
        <option value="{{ p.id }}" {% if selected_filters.player == p.id %}selected{% endif %}>
          {{ p.name }}
        </option>
      {% endfor %}
      </select>
    </label>
  </div>
  <label>
    {{ _("Cup") }}
    <select name="cup">
      <option value="">{{ _("All cups") }}</option>
      {% for cup in cups %}
        <option value="{{ cup.id }}" {% if selected_filters.cup == cup.id %}selected{% endif %}>
          {% if current_lang == 'es' %}
            {{ cup.es }} ({{ cup.en }})
          {% else %}
            {{ cup.en }} ({{ cup.es }})
          {% endif %}
        </option>
      {% endfor %}
    </select>
  </label>
  <label>
    {{ _("Track") }}
    <select name="track">
      <option value="">{{ _("All tracks") }}</option>
      {% for t in tracks %}
        <option value="{{ t.id }}" {% if selected_filters.track == t.id %}selected{% endif %}>
          {% if current_lang == 'es' %}
            {{ t.cup_es }} ‚Äî {{ t.track_es }} ({{ t.track_en }})
          {% else %}
            {{ t.cup_en }} ‚Äî {{ t.track_en }} ({{ t.track_es }})
          {% endif %}
        </option>
      {% endfor %}
    </select>
  </label>
  <label>
    {{ _("Event type") }}
    <select name="event_type">
      <option value="all" {% if selected_filters.event_type == "all" %}selected{% endif %}>{{ _("All events") }}</option>
      <option value="race" {% if selected_filters.event_type == "race" %}selected{% endif %}>{{ _("Races only") }}</option>
      <option value="sweep" {% if selected_filters.event_type == "sweep" %}selected{% endif %}>{{ _("Sweeps only") }}</option>
    </select>
  </label>
  <div class="filter-actions vertical-actions">
    <button class="btn" type="submit">{{ _("Apply filters") }}</button>
    <a class="btn" href="{{ url_for('events_log', season=season_param) }}">{{ _("Reset") }}</a>
  </div>
</form>

<div class="undo-inline">
  <form method="post" action="{{ url_for('undo') }}" data-undo-form>
    <input type="hidden" name="next" value="{{ request.full_path }}">
    <button type="submit">‚Ü©Ô∏è {{ _('Undo last change') }}</button>
  </form>
</div>

<p style="font-size:0.9em;color:#555;margin-top:-4px;">
  {{ _("Showing {count} events for {label}.").format(count=events|length, label=season_label) }}
</p>

{% if not events %}
  <p>{{ _("No events yet for this season.") }}</p>
{% else %}
  <div>
    {% for e in events %}
      <div class="event-card">
        <div class="event-header">
          {{ e.occurred_at }}
          {% if e.is_sweep %}
            ‚Ä¢ <span style="color:#c62828;font-weight:600;">{{ _('SWEEP') }}</span>
          {% endif %}
        </div>

        {% if e.is_sweep %}
          <div>
            üßπ {{ e.sweep_owner }} {{ _('swept') }}
            <strong>
              {% if current_lang == 'es' %}
                {{ e.sweep_cup_es }}
              {% else %}
                {{ e.sweep_cup_en }}
              {% endif %}
            </strong>
            ({% if current_lang == 'es' %}{{ e.sweep_cup_en }}{% else %}{{ e.sweep_cup_es }}{% endif %})
          </div>
        {% else %}
          <div>
            <strong>
              {% if current_lang == 'es' %}
                {{ e.track_es }}
              {% else %}
                {{ e.track_en }}
              {% endif %}
            </strong>
            ({% if current_lang == 'es' %}{{ e.track_en }}{% else %}{{ e.track_es }}{% endif %}) ‚Äî
            {% if current_lang == 'es' %}
              {{ e.cup_es }} ({{ e.cup_en }})
            {% else %}
              {{ e.cup_en }} ({{ e.cup_es }})
            {% endif %}
          </div>
          <div>
            {{ _("Winner:") }} <strong>{{ e.winner }}</strong>
          </div>
          <div class="event-detail">
            {{ _("Before:") }} {{ e.pre_owner or "‚Äî" }}
            {% if e.pre_state == 1 %}({{ _("Locked") }}){% elif e.pre_state == -1 %}({{ _("At risk") }}){% elif e.pre_state == 0 %}({{ _("Default") }}){% endif %}
            {% if e.pre_mark %} ‚Äî {{ _("mark:") }} {{ e.pre_mark }}{% endif %}
          </div>
          <div class="event-detail">
            {{ _("After:") }} {{ e.post_owner or "‚Äî" }}
            {% if e.post_state == 1 %}({{ _("Locked") }}){% elif e.post_state == -1 %}({{ _("At risk") }}){% elif e.post_state == 0 %}({{ _("Default") }}){% endif %}
            {% if e.post_mark %} ‚Äî {{ _("mark:") }} {{ e.post_mark }}{% endif %}
          </div>
        {% endif %}
      </div>
    {% endfor %}
  </div>
{% endif %}

{% endblock %}
