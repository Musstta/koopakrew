{% extends "base.html" %}
{% block body %}

<h2>Event Log</h2>

{% set season_param = request.args.get('season') %}
<div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:8px;">
  <a class="btn" href="{{ url_for('index', season=season_param) }}">Back to standings</a>
  <div style="font-size:0.85em;color:#555;text-align:right;">
    Debug export:
    <a href="{{ url_for('export_events', season=season_param) }}">Events CSV</a>
  </div>
</div>

<form method="get" action="{{ url_for('events_log') }}" class="filter-form" style="margin-bottom:12px;">
  {% if season_param %}
    <input type="hidden" name="season" value="{{ season_param }}">
  {% endif %}
  <label>
    Player
    <select name="player">
      <option value="">All players</option>
      {% for p in players %}
        <option value="{{ p.id }}" {% if selected_filters.player == p.id %}selected{% endif %}>
          {{ p.name }}
        </option>
      {% endfor %}
    </select>
  </label>
  <label>
    Cup
    <select name="cup">
      <option value="">All cups</option>
      {% for cup in cups %}
        <option value="{{ cup.id }}" {% if selected_filters.cup == cup.id %}selected{% endif %}>
          {{ cup.en }} ({{ cup.es }})
        </option>
      {% endfor %}
    </select>
  </label>
  <label>
    Track
    <select name="track">
      <option value="">All tracks</option>
      {% for t in tracks %}
        <option value="{{ t.id }}" {% if selected_filters.track == t.id %}selected{% endif %}>
          {{ t.cup_en }} â€” {{ t.track_en }} ({{ t.track_es }})
        </option>
      {% endfor %}
    </select>
  </label>
  <label>
    Event type
    <select name="event_type">
      <option value="all" {% if selected_filters.event_type == "all" %}selected{% endif %}>All events</option>
      <option value="race" {% if selected_filters.event_type == "race" %}selected{% endif %}>Races only</option>
      <option value="sweep" {% if selected_filters.event_type == "sweep" %}selected{% endif %}>Sweeps only</option>
    </select>
  </label>
  <div class="filter-actions">
    <button class="btn" type="submit">Apply filters</button>
    <a class="btn" href="{{ url_for('events_log', season=season_param) }}">Reset</a>
    {% if default_player %}
      <a class="btn" href="{{ url_for('events_log',
        season=season_param,
        player=default_player.id,
        cup=selected_filters.cup,
        track=selected_filters.track,
        event_type=selected_filters.event_type,
        me=1) }}">
        Involves {{ default_player.name }}
      </a>
    {% endif %}
  </div>
</form>

<p style="font-size:0.9em;color:#555;margin-top:-4px;">
  Showing {{ events|length }} event{{ events|length != 1 and 's' or '' }} for {{ season_label }}.
</p>

{% if not events %}
  <p>No events yet for this season.</p>
{% else %}
  <div>
    {% for e in events %}
      <div class="event-card">
        <div class="event-header">
          {{ e.occurred_at }}
          {% if e.is_sweep %}
            â€¢ <span style="color:#c62828;font-weight:600;">SWEEP</span>
          {% endif %}
        </div>

        {% if e.is_sweep %}
          <div>
            ðŸ§¹ {{ e.sweep_owner }} swept
            <strong>{{ e.sweep_cup_en }}</strong>
            ({{ e.sweep_cup_es }})
          </div>
        {% else %}
          <div>
            <strong>{{ e.track_en }}</strong> ({{ e.track_es }}) â€”
            {{ e.cup_en }} ({{ e.cup_es }})
          </div>
          <div>
            Winner: <strong>{{ e.winner }}</strong>
          </div>
          <div class="event-detail">
            Before: {{ e.pre_owner or "â€”" }}
            {% if e.pre_state == 1 %}(Locked){% elif e.pre_state == -1 %}(At risk){% elif e.pre_state == 0 %}(Default){% endif %}
            {% if e.pre_mark %} â€” mark: {{ e.pre_mark }}{% endif %}
          </div>
          <div class="event-detail">
            After: {{ e.post_owner or "â€”" }}
            {% if e.post_state == 1 %}(Locked){% elif e.post_state == -1 %}(At risk){% elif e.post_state == 0 %}(Default){% endif %}
            {% if e.post_mark %} â€” mark: {{ e.post_mark }}{% endif %}
          </div>
        {% endif %}
      </div>
    {% endfor %}
  </div>
{% endif %}

{% endblock %}
