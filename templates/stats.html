{% extends "base.html" %}
{% block body %}

<h2>Season stats</h2>

<h3>Per-player overview</h3>
<form method="get" class="filter-form" style="max-width:360px;margin-bottom:12px;">
  <label>
    Sort players by
    <select name="sort">
      {% for option in metric_sort_options %}
        <option value="{{ option.id }}" {% if option.id == selected_sort %}selected{% endif %}>
          {{ option.label }}
        </option>
      {% endfor %}
    </select>
  </label>
  {% if selected_track %}
    <input type="hidden" name="track_id" value="{{ selected_track.id }}">
  {% endif %}
  <button class="btn" type="submit">Update</button>
</form>

<div class="table-scroll">
  <table class="stats-table">
    <thead>
      <tr>
        <th>Metric</th>
        {% for p in player_stats %}
          <th>{{ p.name }}</th>
        {% endfor %}
      </tr>
    </thead>
    <tbody>
      {% for metric in metric_rows %}
        <tr class="metric-group-{{ metric.group }}">
          <td class="metric-name">
            {{ metric.label }}
            {% if metric.help %}
              <button type="button" class="info-tip"></button>
              <span class="info-text">{{ metric.help }}</span>
            {% endif %}
          </td>
          {% for cell in metric.cells %}
            {% set highlight = metric.max_highlight is not none and cell.highlight == metric.max_highlight %}
            <td class="{% if highlight %}top-value{% endif %}" style="text-align:right;">
              {% if metric.type == "value" %}
                {{ cell.value }}
              {% elif metric.type == "pair" %}
                {{ cell.num }} / {{ cell.den }}
              {% elif metric.type == "percent" %}
                {% if cell.percent is not none %}
                  {{ "%.1f"|format(cell.percent) }}%
                {% else %}
                  —
                {% endif %}
              {% else %}
                —
              {% endif %}
            </td>
          {% endfor %}
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<div class="stats-legend">
  <span class="legend-pill control">Track control</span>
  <span class="legend-pill performance">Race performance</span>
  <span class="legend-pill risk">Risk / hunter plays</span>
  <span class="legend-pill defense">Defense</span>
</div>
<p class="event-detail">
  Risk rows track who is pushing tracks into ⚠️ status. Hunter marks show how often someone sets a target and later steals it.
</p>

<h3>Highlights</h3>
<ul>
  {% if most_defended %}
    <li>
      <strong>Most defended track:</strong>
      {{ most_defended.track_en }} ({{ most_defended.track_es }}) —
      {{ most_defended.cup_en }} ({{ most_defended.cup_es }})
      — {{ most_defended.defenses }} successful defenses
    </li>
  {% endif %}
  {% if most_contested %}
    <li>
      <strong>Most contested track:</strong>
      {{ most_contested.track_en }} ({{ most_contested.track_es }}) —
      {{ most_contested.cup_en }} ({{ most_contested.cup_es }})
      — {{ most_contested.changes }} ownership changes
    </li>
  {% endif %}
</ul>

<h3>Most active tracks (by races)</h3>
{% if track_activity %}
  <table border="1" cellpadding="4" cellspacing="0">
    <thead>
      <tr>
        <th>Track</th>
        <th>Cup</th>
        <th>Races</th>
      </tr>
    </thead>
    <tbody>
      {% for t in track_activity %}
        <tr>
          <td>{{ t.track_en }} ({{ t.track_es }})</td>
          <td>{{ t.cup_en }} ({{ t.cup_es }})</td>
          <td style="text-align:right;">{{ t.races }}</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
{% else %}
  <p>No races recorded yet this season.</p>
{% endif %}

<h3>Track insights</h3>

<form method="get" action="{{ url_for('stats_page') }}" style="margin-bottom:8px;">
  <label for="track_id">Choose a track:</label>
  <select name="track_id" id="track_id">
    {% for t in track_selector %}
      <option value="{{ t.id }}"
        {% if selected_track and selected_track.id == t.id %}selected{% endif %}>
        {{ t.cup_en }} — {{ t.track_en }} ({{ t.track_es }})
      </option>
    {% endfor %}
  </select>
  <button class="btn" type="submit">View</button>
</form>

{% if selected_track %}
  <h4>
    {{ selected_track.en }} ({{ selected_track.es }}) —
    {{ selected_track.cup_en }} ({{ selected_track.cup_es }})
  </h4>

  <h5>Per-player on this track</h5>
  {% if track_player_stats %}
    <table border="1" cellpadding="4" cellspacing="0">
      <thead>
        <tr>
          <th>Player</th>
          <th>Wins</th>
          <th>Defenses</th>
          <th>Times taken</th>
          <th>Times lost</th>
        </tr>
      </thead>
      <tbody>
        {% for s in track_player_stats %}
          <tr>
            <td><strong>{{ s.name }}</strong></td>
            <td style="text-align:right;">{{ s.wins }}</td>
            <td style="text-align:right;">{{ s.defenses }}</td>
            <td style="text-align:right;">{{ s.takes }}</td>
            <td style="text-align:right;">{{ s.losses }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p>No races have been recorded on this track yet.</p>
  {% endif %}

  <h5>Event history</h5>
  {% if track_events %}
    <ul>
      {% for e in track_events %}
        <li>
          {{ e.occurred_at }} —
          {{ e.winner_name or "—" }} won.
          Before: {{ e.pre_owner_name or "—" }} →
          After: {{ e.post_owner_name or "—" }}.
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p>No events yet for this track.</p>
  {% endif %}
{% endif %}

{% endblock %}
