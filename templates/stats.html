{% extends "base.html" %}
{% block body %}

<h2>{{ _("Season stats") }}</h2>

<form method="get" class="filter-form" style="max-width:480px;margin-bottom:12px;">
  <label>
    {{ _("Sort players by") }}
    <select name="sort">
      {% for option in metric_sort_options %}
        <option value="{{ option.id }}" {% if option.id == selected_sort %}selected{% endif %}>
          {{ option.label }}
        </option>
      {% endfor %}
    </select>
  </label>
  <label>
    {{ _("Season") }}
    <select name="season">
      {% for option in season_options %}
        <option value="{{ option.id }}" {% if option.id == selected_season %}selected{% endif %}>
          {{ option.label }}
        </option>
      {% endfor %}
    </select>
  </label>
  {% if selected_track %}
    <input type="hidden" name="track_id" value="{{ selected_track.id }}">
  {% endif %}
  <button class="btn" type="submit">{{ _("Update") }}</button>
</form>
{% if track_insights_enabled %}
  <form method="get" action="{{ url_for('stats_page') }}" style="margin-bottom:12px;">
    <label for="track_id">{{ _("Choose a track:") }}</label>
    <select name="track_id" id="track_id">
      {% for t in track_selector %}
        <option value="{{ t.id }}"
          {% if selected_track and selected_track.id == t.id %}selected{% endif %}>
          {% if current_lang == 'es' %}
            {{ t.cup_es }} ‚Äî {{ t.track_es }} ({{ t.track_en }})
          {% else %}
            {{ t.cup_en }} ‚Äî {{ t.track_en }} ({{ t.track_es }})
          {% endif %}
        </option>
      {% endfor %}
    </select>
    <button class="btn" type="submit" style="margin-left:8px;">{{ _("View") }}</button>
    {% if selected_sort %}
      <input type="hidden" name="sort" value="{{ selected_sort }}">
    {% endif %}
    {% if selected_season %}
      <input type="hidden" name="season" value="{{ selected_season }}">
    {% endif %}
  </form>
{% else %}
  <p class="event-detail">{{ _("Track insights are only available when viewing a single season.") }}</p>
{% endif %}

{% set badge_hot = streak_badges.hot_hand if streak_badges else None %}
{% set badge_def = streak_badges.shield_wall if streak_badges else None %}
{% if badge_hot or badge_def %}
  <div class="totals streak-panel">
    {% if badge_hot %}
      üî• <strong>{{ _("Hot hand:") }}</strong> {{ badge_hot.player }} ({{ _('{count} wins').format(count=badge_hot.streak) }})
    {% endif %}
    {% if badge_hot and badge_def %}<br>{% endif %}
    {% if badge_def %}
      üõ°Ô∏è <strong>{{ _("Shield wall:") }}</strong> {{ badge_def.player }} ({{ _('{count} defenses').format(count=badge_def.streak) }})
    {% endif %}
  </div>
{% endif %}

<div class="table-scroll">
  <table class="stats-table">
    <thead>
      <tr>
        <th>{{ _("Metric") }}</th>
        {% for p in player_stats %}
          <th>{{ p.name }}</th>
        {% endfor %}
      </tr>
    </thead>
    <tbody>
        {% for metric in metric_rows %}
          <tr class="metric-group-{{ metric.group }}">
            <td class="metric-name">
            {{ metric.label }}
            {% if metric.help %}
              <button type="button" class="info-tip"></button>
              <span class="info-text">{{ metric.help }}</span>
            {% endif %}
          </td>
            {% for cell in metric.cells %}
              {% set highlight = metric.max_highlight is not none and cell.highlight == metric.max_highlight %}
              <td class="{% if highlight %}top-value{% endif %}" style="text-align:right;">
                {% if highlight %}üëë {% endif %}
                {% if metric.type == "value" %}
                  {{ cell.value }}
                {% elif metric.type == "pair" %}
                  {{ cell.num }} / {{ cell.den }}
                {% elif metric.type == "percent" %}
                {% if cell.percent is not none %}
                  {{ "%.1f"|format(cell.percent) }}%
                {% else %}
                  ‚Äî
                {% endif %}
              {% else %}
                ‚Äî
              {% endif %}
            </td>
          {% endfor %}
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<div class="stats-legend">
  <span class="legend-pill control">{{ _("Track control") }}</span>
  <span class="legend-pill performance">{{ _("Race performance") }}</span>
  <span class="legend-pill risk">{{ _("Risk / hunter plays") }}</span>
  <span class="legend-pill defense">{{ _("Defense") }}</span>
</div>
<p class="event-detail">
  {{ _("Risk rows track who is pushing tracks into ‚ö†Ô∏è status. Hunter marks show how often someone sets a target and later steals it.") }}
</p>

<h3>{{ _("Highlights") }}</h3>
<ul>
  {% if most_defended %}
    <li>
      <strong>{{ _("Most defended track:") }}</strong>
      {% if current_lang == 'es' %}
        {{ most_defended.track_es }} ({{ most_defended.track_en }}) ‚Äî
        {{ most_defended.cup_es }} ({{ most_defended.cup_en }})
      {% else %}
        {{ most_defended.track_en }} ({{ most_defended.track_es }}) ‚Äî
        {{ most_defended.cup_en }} ({{ most_defended.cup_es }})
      {% endif %}
      ‚Äî {{ _('{count} successful defenses').format(count=most_defended.defenses) }}
    </li>
  {% endif %}
  {% if most_contested %}
    <li>
      <strong>{{ _("Most contested track:") }}</strong>
      {% if current_lang == 'es' %}
        {{ most_contested.track_es }} ({{ most_contested.track_en }}) ‚Äî
        {{ most_contested.cup_es }} ({{ most_contested.cup_en }})
      {% else %}
        {{ most_contested.track_en }} ({{ most_contested.track_es }}) ‚Äî
        {{ most_contested.cup_en }} ({{ most_contested.cup_es }})
      {% endif %}
      ‚Äî {{ _('{count} ownership changes').format(count=most_contested.changes) }}
    </li>
  {% endif %}
</ul>

<h3>{{ _("Most active tracks (by races)") }}</h3>
{% if track_activity %}
  <table border="1" cellpadding="4" cellspacing="0">
    <thead>
      <tr>
        <th>{{ _("Track") }}</th>
        <th>{{ _("Cup") }}</th>
        <th>{{ _("Races") }}</th>
      </tr>
    </thead>
    <tbody>
      {% for t in track_activity %}
        <tr>
          {% if current_lang == 'es' %}
            <td>{{ t.track_es }} ({{ t.track_en }})</td>
            <td>{{ t.cup_es }} ({{ t.cup_en }})</td>
          {% else %}
            <td>{{ t.track_en }} ({{ t.track_es }})</td>
            <td>{{ t.cup_en }} ({{ t.cup_es }})</td>
          {% endif %}
          <td style="text-align:right;">{{ t.races }}</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
{% else %}
  <p>{{ _("No races recorded yet this season.") }}</p>
{% endif %}

<h3>{{ _("Track insights") }}</h3>

{% if selected_track %}
  <h4>
    {% if current_lang == 'es' %}
      {{ selected_track.es }} ({{ selected_track.en }}) ‚Äî
      {{ selected_track.cup_es }} ({{ selected_track.cup_en }})
    {% else %}
      {{ selected_track.en }} ({{ selected_track.es }}) ‚Äî
      {{ selected_track.cup_en }} ({{ selected_track.cup_es }})
    {% endif %}
  </h4>

  <h5>{{ _("Per-player on this track") }}</h5>
  {% if track_player_stats %}
    <table border="1" cellpadding="4" cellspacing="0">
      <thead>
        <tr>
          <th>{{ _("Player") }}</th>
          <th>{{ _("Wins") }}</th>
          <th>{{ _("Defenses") }}</th>
          <th>{{ _("Times taken") }}</th>
          <th>{{ _("Times lost") }}</th>
        </tr>
      </thead>
      <tbody>
        {% for s in track_player_stats %}
          <tr>
            <td><strong>{{ s.name }}</strong></td>
            <td style="text-align:right;">{{ s.wins }}</td>
            <td style="text-align:right;">{{ s.defenses }}</td>
            <td style="text-align:right;">{{ s.takes }}</td>
            <td style="text-align:right;">{{ s.losses }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
    {% set track_master = track_player_stats[0] if track_player_stats else None %}
    {% if track_master %}
      <p><strong>üèÅ {{ _("Track master:") }}</strong> {{ track_master.name }} ({{ _('{count} wins').format(count=track_master.wins) }})</p>
    {% endif %}
  {% else %}
    <p>{{ _("No races have been recorded on this track yet.") }}</p>
  {% endif %}

  <h5>{{ _("Event history") }}</h5>
  {% if track_events %}
    <ul>
      {% for e in track_events %}
        <li>
          {{ e.occurred_at }} ‚Äî
          {{ e.winner_name or "‚Äî" }} {{ _("won.") }}
          {{ _("Before:") }} {{ e.pre_owner_name or "‚Äî" }} ‚Üí
          {{ _("After:") }} {{ e.post_owner_name or "‚Äî" }}.
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p>{{ _("No events yet for this track.") }}</p>
  {% endif %}
{% endif %}

{% endblock %}
