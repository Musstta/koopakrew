{% extends "base.html" %}
{% block body %}

<h2>{{ _("Season stats") }}</h2>

<form method="get" class="filter-form" style="max-width:480px;margin-bottom:12px;">
  <label>
    {{ _("Season") }}
    <select name="season">
      {% for option in season_options %}
        <option value="{{ option.id }}" {% if option.id == selected_season %}selected{% endif %}>
          {{ option.label }}
        </option>
      {% endfor %}
    </select>
  </label>
  {% set current_track_id = selected_track.id if selected_track else selected_track_id %}
  {% if current_track_id %}
    <input type="hidden" name="track_id" value="{{ current_track_id }}">
  {% endif %}
  {% if selected_sort %}
    <input type="hidden" name="sort" value="{{ selected_sort }}">
  {% endif %}
  <button class="btn" type="submit">{{ _("Update") }}</button>
</form>
{% if track_insights_enabled %}
  <form method="get" action="{{ url_for('stats_page') }}" style="margin-bottom:12px;">
    <label for="track_id">{{ _("Choose a track:") }}</label>
    <select name="track_id" id="track_id">
      {% for t in track_selector %}
        <option value="{{ t.id }}"
          {% if selected_track and selected_track.id == t.id %}selected{% endif %}>
          {% if current_lang == 'es' %}
            {{ t.cup_es }} â€” {{ t.track_es }} ({{ t.track_en }})
          {% else %}
            {{ t.cup_en }} â€” {{ t.track_en }} ({{ t.track_es }})
          {% endif %}
        </option>
      {% endfor %}
    </select>
    <button class="btn" type="submit" style="margin-left:8px;">{{ _("View") }}</button>
    {% if selected_sort %}
      <input type="hidden" name="sort" value="{{ selected_sort }}">
    {% endif %}
    {% if selected_season %}
      <input type="hidden" name="season" value="{{ selected_season }}">
    {% endif %}
  </form>
{% else %}
  <p class="event-detail">{{ _("Track insights are only available when viewing a single season.") }}</p>
{% endif %}

<p class="event-detail">{{ _("Click any metric row to sort players by that stat.") }}</p>

{% if track_insights_enabled %}
  <div class="track-insights-panel">
    <h3>{{ _("Track insights") }}</h3>
    {% if selected_track %}
      <h4>
        {% if current_lang == 'es' %}
          {{ selected_track.es }} ({{ selected_track.en }}) â€”
          {{ selected_track.cup_es }} ({{ selected_track.cup_en }})
        {% else %}
          {{ selected_track.en }} ({{ selected_track.es }}) â€”
          {{ selected_track.cup_en }} ({{ selected_track.cup_es }})
        {% endif %}
      </h4>

      <h5>{{ _("Per-player on this track") }}</h5>
      {% if track_player_stats %}
        <table border="1" cellpadding="4" cellspacing="0">
          <thead>
            <tr>
              <th>{{ _("Player") }}</th>
              <th>{{ _("Wins") }}</th>
              <th>{{ _("Defenses") }}</th>
              <th>{{ _("Times taken") }}</th>
              <th>{{ _("Times lost") }}</th>
            </tr>
          </thead>
          <tbody>
            {% for s in track_player_stats %}
              <tr>
                <td><strong>{{ s.name }}</strong></td>
                <td style="text-align:right;">{{ s.wins }}</td>
                <td style="text-align:right;">{{ s.defenses }}</td>
                <td style="text-align:right;">{{ s.takes }}</td>
                <td style="text-align:right;">{{ s.losses }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
        {% set track_master = track_player_stats[0] if track_player_stats else None %}
        {% if track_master %}
          <p><strong>ğŸ {{ _("Track master:") }}</strong> {{ track_master.name }} ({{ _('{count} wins').format(count=track_master.wins) }})</p>
        {% endif %}
      {% else %}
        <p>{{ _("No races have been recorded on this track yet.") }}</p>
      {% endif %}

      <h5>{{ _("Event history") }}</h5>
      {% if track_events %}
        <ul>
          {% for e in track_events %}
            <li>
              {{ e.occurred_at }} â€”
              {{ e.winner_name or "â€”" }} {{ _("won.") }}
              {{ _("Before:") }} {{ e.pre_owner_name or "â€”" }} â†’
              {{ _("After:") }} {{ e.post_owner_name or "â€”" }}.
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p>{{ _("No events yet for this track.") }}</p>
      {% endif %}
    {% else %}
      <p>{{ _("Pick a track to drill into per-player history.") }}</p>
    {% endif %}
  </div>
{% endif %}

{% set badge_hot = streak_badges.hot_hand if streak_badges else None %}
{% set badge_def = streak_badges.shield_wall if streak_badges else None %}
{% if badge_hot or badge_def %}
  <div class="totals streak-panel">
    {% if badge_hot %}
      ğŸ”¥ <strong>{{ _("Hot hand:") }}</strong> {{ badge_hot.player }} ({{ _('{count} wins').format(count=badge_hot.streak) }})
    {% endif %}
    {% if badge_hot and badge_def %}<br>{% endif %}
    {% if badge_def %}
      ğŸ›¡ï¸ <strong>{{ _("Shield wall:") }}</strong> {{ badge_def.player }} ({{ _('{count} defenses').format(count=badge_def.streak) }})
    {% endif %}
  </div>
{% endif %}

<div class="table-scroll">
  <table class="stats-table">
    <thead>
      <tr>
        <th>{{ _("Metric") }}</th>
        {% for p in player_stats %}
          <th>{{ p.name }}</th>
        {% endfor %}
      </tr>
    </thead>
    <tbody>
        {% for metric in metric_rows %}
          <tr class="metric-group-{{ metric.group }}">
            {% set track_query_id = selected_track.id if selected_track else selected_track_id %}
            <td class="metric-name {% if metric.id == selected_sort %}metric-selected{% endif %}">
            <a class="metric-sort-link {% if metric.id == selected_sort %}active{% endif %}"
              href="{{ url_for('stats_page', season=selected_season, sort=metric.id, track_id=track_query_id) }}">
              {{ metric.label }}
            </a>
            {% if metric.help %}
              <button type="button" class="info-tip"></button>
              <span class="info-text">{{ metric.help }}</span>
            {% endif %}
          </td>
            {% for cell in metric.cells %}
              {% set highlight = metric.max_highlight is not none and cell.highlight == metric.max_highlight %}
              <td class="{% if highlight %}top-value{% endif %}" style="text-align:right;">
                {% if highlight %}ğŸ‘‘ {% endif %}
                {% if metric.type == "value" %}
                  {{ cell.value }}
                {% elif metric.type == "pair" %}
                  {{ cell.num }} / {{ cell.den }}
                {% elif metric.type == "percent" %}
                {% if cell.percent is not none %}
                  {{ "%.1f"|format(cell.percent) }}%
                {% else %}
                  â€”
                {% endif %}
              {% else %}
                â€”
              {% endif %}
            </td>
          {% endfor %}
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<div class="stats-legend">
  <span class="legend-pill control">{{ _("Track control") }}</span>
  <span class="legend-pill performance">{{ _("Race performance") }}</span>
  <span class="legend-pill risk">{{ _("Risk / hunter plays") }}</span>
  <span class="legend-pill defense">{{ _("Defense") }}</span>
</div>
<p class="event-detail">
  {{ _("Risk rows track who is pushing tracks into âš ï¸ status. Hunter marks show how often someone sets a target and later steals it.") }}
</p>

{% if player_spotlights %}
  <h3>{{ _("Player spotlights") }}</h3>
  <div class="player-spotlights">
    {% for card in player_spotlights %}
      <div class="spotlight-card">
        <strong>{{ card.name }}</strong>
        <ul>
          <li>ğŸ” <strong>{{ _("Locks applied:") }}</strong> {{ card.locks_applied }}</li>
          <li>ğŸ¯ <strong>{{ _("Hunter marks:") }}</strong> {{ card.hunter_marks }}</li>
          {% if card.cups_owned %}
            <li>
              ğŸ† <strong>{{ _("Cups owned:") }}</strong>
              {% for cup in card.cups_owned %}
                {% if current_lang == 'es' %}
                  {{ cup.cup_es }}
                {% else %}
                  {{ cup.cup_en }}
                {% endif %}
                {% if not loop.last %}, {% endif %}
              {% endfor %}
            </li>
          {% endif %}
          {% if card.best_track %}
            <li>
              ğŸ <strong>{{ _("Best track:") }}</strong>
              {% set bt_name = card.best_track.track_es if current_lang == 'es' else card.best_track.track_en %}
              {{ bt_name }}
              â€” {{ _('{count} wins').format(count=card.best_track.count) }}
            </li>
          {% endif %}
          {% if card.most_defended_track %}
            <li>
              ğŸ›¡ï¸ <strong>{{ _("Most defended:") }}</strong>
              {% set md_name = card.most_defended_track.track_es if current_lang == 'es' else card.most_defended_track.track_en %}
              {{ md_name }}
              â€” {{ _('{count} defenses').format(count=card.most_defended_track.count) }}
            </li>
          {% endif %}
          {% if card.most_attacked_track %}
            <li>
              âš”ï¸ <strong>{{ _("Most attacked:") }}</strong>
              {% set ma_name = card.most_attacked_track.track_es if current_lang == 'es' else card.most_attacked_track.track_en %}
              {{ ma_name }}
              â€” {{ _('{count} attacks').format(count=card.most_attacked_track.count) }}
            </li>
          {% endif %}
          {% if card.favorite_cup %}
            <li>
              ğŸ¥‡ <strong>{{ _("Favorite cup:") }}</strong>
              {% if current_lang == 'es' %}
                {{ card.favorite_cup.cup_es }} ({{ card.favorite_cup.cup_en }})
              {% else %}
                {{ card.favorite_cup.cup_en }} ({{ card.favorite_cup.cup_es }})
              {% endif %}
              â€” {{ _('{count} wins').format(count=card.favorite_cup.wins) }}
            </li>
          {% endif %}
        </ul>
      </div>
    {% endfor %}
  </div>
{% endif %}

<h3>{{ _("Highlights") }}</h3>
<ul>
  {% if most_defended %}
    <li>
      <strong>{{ _("Most defended track:") }}</strong>
      {% if current_lang == 'es' %}
        {{ most_defended.track_es }} ({{ most_defended.track_en }}) â€”
        {{ most_defended.cup_es }} ({{ most_defended.cup_en }})
      {% else %}
        {{ most_defended.track_en }} ({{ most_defended.track_es }}) â€”
        {{ most_defended.cup_en }} ({{ most_defended.cup_es }})
      {% endif %}
      â€” {{ _('{count} successful defenses').format(count=most_defended.defenses) }}
    </li>
  {% endif %}
  {% if most_contested %}
    <li>
      <strong>{{ _("Most contested track:") }}</strong>
      {% if current_lang == 'es' %}
        {{ most_contested.track_es }} ({{ most_contested.track_en }}) â€”
        {{ most_contested.cup_es }} ({{ most_contested.cup_en }})
      {% else %}
        {{ most_contested.track_en }} ({{ most_contested.track_es }}) â€”
        {{ most_contested.cup_en }} ({{ most_contested.cup_es }})
      {% endif %}
      â€” {{ _('{count} ownership changes').format(count=most_contested.changes) }}
    </li>
  {% endif %}
</ul>

<h3>{{ _("Most active tracks (by races)") }}</h3>
{% if track_activity %}
  <table border="1" cellpadding="4" cellspacing="0">
    <thead>
      <tr>
        <th>{{ _("Track") }}</th>
        <th>{{ _("Cup") }}</th>
        <th>{{ _("Races") }}</th>
      </tr>
    </thead>
    <tbody>
      {% for t in track_activity %}
        <tr>
          {% if current_lang == 'es' %}
            <td>{{ t.track_es }} ({{ t.track_en }})</td>
            <td>{{ t.cup_es }} ({{ t.cup_en }})</td>
          {% else %}
            <td>{{ t.track_en }} ({{ t.track_es }})</td>
            <td>{{ t.cup_en }} ({{ t.cup_es }})</td>
          {% endif %}
          <td style="text-align:right;">{{ t.races }}</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
{% else %}
  <p>{{ _("No races recorded yet this season.") }}</p>
{% endif %}

{% endblock %}
