{% extends "base.html" %}
{% block body %}

<h2>{{ _("Season archive") }}</h2>

{% if archive_entries %}
  <form method="get" class="filter-form" style="max-width:320px;margin-bottom:12px;">
    <label>
      {{ _("Season") }}
      <select name="season">
        {% for entry in archive_entries %}
          <option value="{{ entry.id }}" {% if selected_archive_id == entry.id %}selected{% endif %}>
            {{ entry.label }}
          </option>
        {% endfor %}
      </select>
    </label>
    <button class="btn" type="submit">{{ _("View") }}</button>
  </form>
{% endif %}

{% if archive_data %}
    <div class="totals champion-panel">
      <strong>{{ archive_data.label }}</strong>
      {% if archive_data.champions %}
      <div style="margin-top:4px;">üèÜ {{ _("Champion:") }} {{ archive_data.champions | join(", ") }}</div>
      {% endif %}
    {% if archive_data.notes %}
      <div style="font-size:0.9em;color:#555;">{{ archive_data.notes }}</div>
    {% endif %}
  </div>

  {% if archive_data.mode == 'csv' %}
    <div class="totals">
      <strong>{{ _("Final track counts") }}</strong>
      <ol style="margin:.4em 0 0 1.2em;padding:0;">
        {% for owner, count in archive_data.totals %}
          <li style="list-style:none;margin:.1em 0;">{{ owner }} ‚Äî {{ count }}</li>
        {% endfor %}
      </ol>
    </div>
    {% for cup in archive_data.cups %}
      <div class="totals">
        <strong>{{ cup.cup_name }}</strong>
        <ul>
          {% for track in cup.tracks %}
            <li>{{ track.track }} ‚Äî {{ track.owner or "‚Äî" }} {% if track.state %}<em>({{ track.state }})</em>{% endif %}</li>
          {% endfor %}
        </ul>
      </div>
    {% endfor %}
  {% else %}
    <div class="totals">
      <strong>{{ _("Final standings") }}</strong>
      <ol style="margin:.4em 0 0 1.2em;padding:0;">
        {% for owner, count in archive_data.totals %}
          <li style="list-style:none;margin:.1em 0;">{{ owner }} ‚Äî {{ count }}</li>
        {% endfor %}
      </ol>
    </div>

    {% if archive_data.highlights %}
      <div class="totals highlight-panel">
        <strong>{{ _("Highlights") }}</strong>
        <ul>
          {% for hl in archive_data.highlights %}
            <li>{{ hl.label }}: {{ hl.player }} ({{ hl.value }})</li>
          {% endfor %}
        </ul>
      </div>
    {% endif %}

    {% if archive_data.stats and archive_data.stats.track_activity %}
      <div class="totals">
        <strong>{{ _("Most active tracks") }}</strong>
        <ol style="margin:.4em 0 0 1.2em;padding:0;">
          {% for track in archive_data.stats.track_activity %}
            <li style="list-style:none;margin:.1em 0;">
              {% if current_lang == 'es' %}
                {{ track.track_es or track.track_en }} ({{ track.cup_es or track.cup_en }}) ‚Äî {{ _('{count} races').format(count=track.races) }}
              {% else %}
                {{ track.track_en }} ({{ track.cup_en }}) ‚Äî {{ _('{count} races').format(count=track.races) }}
              {% endif %}
            </li>
          {% endfor %}
        </ol>
      </div>
    {% endif %}

    {% for cup in archive_data.standings %}
      <details class="cup-panel" open>
        <summary>
          <div class="cup-logo">
            {% if cup.logo_src %}
              <img src="{{ cup.logo_src }}" alt="{{ cup.cup_en }} logo">
            {% else %}
              {% set cup_initial = cup.cup_es if current_lang == 'es' else cup.cup_en %}
              <div class="cup-logo-placeholder">{{ cup_initial[0] }}</div>
            {% endif %}
          </div>
          <div>
            {% if current_lang == 'es' %}
              <h2 style="margin:0;">{{ cup.cup_es }} ({{ cup.cup_en }})</h2>
            {% else %}
              <h2 style="margin:0;">{{ cup.cup_en }} ({{ cup.cup_es }})</h2>
            {% endif %}
          </div>
        </summary>
        <div class="cup-tracks">
          {% for t in cup.tracks %}
            {% set has_art = t.image_src is not none %}
            <div class="track-card {% if has_art %}has-art{% endif %}" {% if has_art %}style="--track-art: url('{{ t.image_src }}');"{% endif %}>
              <div class="track-thumb-wrapper">
                {% if has_art %}
                  <img class="track-thumb" src="{{ t.image_src }}" alt="{{ t.track_en }}">
                {% else %}
                  {% set track_initial = t.track_es if current_lang == 'es' else t.track_en %}
                  <div class="track-thumb-placeholder">{{ track_initial[0] }}</div>
                {% endif %}
              </div>
              <div class="track-content">
                <div class="track-names">
                  {% if current_lang == 'es' %}
                    <strong>{{ t.track_es }}</strong>
                    <small>{{ t.track_en }}</small>
                  {% else %}
                    <strong>{{ t.track_en }}</strong>
                    <small>{{ t.track_es }}</small>
                  {% endif %}
                </div>
                <div class="owner-line">{{ _('Owner:') }} {{ t.owner or "‚Äî" }}</div>
                <div class="track-state">
                  {% if t.state == 1 %}
                    <span class="badge badge-locked">üîí {{ _("Locked") }}</span>
                  {% elif t.state == -1 %}
                    <span class="badge badge-risk">‚ö†Ô∏è {{ _("At risk") }}</span>
                    {% if t.threatened_by %}
                      <span class="badge badge-hunter">üéØ {{ t.threatened_by }}</span>
                    {% endif %}
                  {% else %}
                    <span class="badge badge-default">{{ _("Default") }}</span>
                  {% endif %}
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      </details>
    {% endfor %}
  {% endif %}
{% else %}
  <p>{{ _("No archive data available.") }}</p>
{% endif %}

{% endblock %}
