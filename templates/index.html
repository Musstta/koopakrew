{% extends "base.html" %}
{% block body %}

<form method="get" class="totals filter-form">
  <label>
    Owner
    <select id="owner" name="owner">
      <option value="all" {{ "selected" if selected_filters.owner == "all" else "" }}>All</option>
      {% for p in players %}
        <option value="{{ p }}" {{ "selected" if selected_filters.owner == p else "" }}>{{ p }}</option>
      {% endfor %}
    </select>
  </label>
  <label>
    Cup
    <select id="cup" name="cup">
      <option value="all" {{ "selected" if selected_filters.cup == "all" else "" }}>All</option>
      {% for c in cups %}
        <option value="{{ c.code }}" {{ "selected" if selected_filters.cup == c.code else "" }}>
          {{ c.en }} ({{ c.es }})
        </option>
      {% endfor %}
    </select>
  </label>
  <label>
    State
    <select id="state" name="state">
      <option value="any" {{ "selected" if selected_filters.state == "any" else "" }}>Any</option>
      <option value="locked" {{ "selected" if selected_filters.state == "locked" else "" }}>Locked</option>
      <option value="default" {{ "selected" if selected_filters.state == "default" else "" }}>Default</option>
      <option value="at-risk" {{ "selected" if selected_filters.state in ["at-risk","atrisk","at_risk"] else "" }}>At Risk</option>
    </select>
  </label>
  <div class="filter-actions">
    <button class="btn" type="submit">Apply</button>
    <a class="btn" href="{{ url_for('index') }}">Reset</a>
  </div>
</form>

<div style="text-align:right;margin-top:-8px;margin-bottom:12px;font-size:0.85em;color:#555;">
  Debug exports:
  <a href="{{ url_for('export_standings', owner=selected_filters.owner, cup=selected_filters.cup, state=selected_filters.state) }}">
    Standings CSV
  </a>
  Â·
  <a href="{{ url_for('export_events') }}">Events CSV</a>
</div>

{% if default_player %}
  <div class="totals" style="background:#e3f2fd;">
    Quick updates enabled for <strong>{{ default_player.name }}</strong>. Set a different default in the Players tab.
  </div>
{% else %}
  <div class="totals">
    Tip: set a default player from the Players tab to unlock the â€œI won this oneâ€ shortcut.
  </div>
{% endif %}

<div class="totals">
  <strong>Tracks owned:</strong>
  {% if not totals_overall %}
    â€”
  {% else %}
    <ol style="margin:.2em 0 0 1.2em;padding:0;">
      {% for pair in totals_overall %}
        {% set p = pair[0] %}
        {% set n = pair[1] %}
        <li style="list-style:none;margin:.1em 0;">
          {% if loop.index0 == 0 %}ğŸ¥‡{% elif loop.index0 == 1 %}ğŸ¥ˆ{% elif loop.index0 == 2 %}ğŸ¥‰{% else %}{{ loop.index }}.{% endif %}
          {{ p }}: {{ n }}
        </li>
      {% endfor %}
    </ol>
  {% endif %}

  {% set filtering = selected_filters.owner != "all" or selected_filters.cup != "all" or selected_filters.state != "any" %}
  {% if filtering %}
    <br>
    <strong>Filtered tracks owned:</strong>
    {% if not totals_filtered %}
      â€”
    {% else %}
      <ol style="margin:.2em 0 0 1.2em;padding:0;">
        {% for pair in totals_filtered %}
          {% set p = pair[0] %}
          {% set n = pair[1] %}
          <li style="list-style:none;margin:.1em 0;">
            {% if loop.index0 == 0 %}ğŸ¥‡{% elif loop.index0 == 1 %}ğŸ¥ˆ{% elif loop.index0 == 2 %}ğŸ¥‰{% else %}{{ loop.index }}.{% endif %}
            {{ p }}: {{ n }}
          </li>
        {% endfor %}
      </ol>
    {% endif %}
  {% endif %}
</div>

{% for cup in standings %}
  <details class="cup-panel" open>
    <summary>
      <div class="cup-logo">
        {% if cup.logo_src %}
          <img src="{{ cup.logo_src }}" alt="{{ cup.cup_en }} logo">
        {% else %}
          <div class="cup-logo-placeholder">{{ cup.cup_en[0] }}</div>
        {% endif %}
      </div>
      <div>
        <h2 style="margin:0;">{{ cup.cup_en }} ({{ cup.cup_es }})</h2>
      </div>
    </summary>
    <div class="cup-tracks">
      {% for t in cup.tracks %}
        {% set has_art = t.image_src is not none %}
        <div class="track-card {% if has_art %}has-art{% endif %}" {% if has_art %}style="--track-art: url('{{ t.image_src }}');"{% endif %}>
          <div class="track-thumb-wrapper">
            {% if has_art %}
              <img class="track-thumb" src="{{ t.image_src }}" alt="{{ t.track_en }}">
            {% else %}
              <div class="track-thumb-placeholder">{{ t.track_en[0] }}</div>
            {% endif %}
          </div>
          <div class="track-content">
            <div class="track-names">
              <strong>{{ t.track_en }}</strong>
              <small>{{ t.track_es }}</small>
            </div>
            <div class="owner-line">
              Owner: {{ t.owner or "â€”" }}
            </div>
            <div class="track-state">
              {% if t.state == 1 %}
                <span class="badge badge-locked">ğŸ”’ Locked</span>
              {% elif t.state == -1 %}
                <span class="badge badge-risk">âš ï¸ At risk</span>
                {% if t.threatened_by %}
                  <span class="badge badge-hunter">ğŸ¯ {{ t.threatened_by }}</span>
                {% endif %}
              {% else %}
                <span class="badge badge-default">Default</span>
              {% endif %}
            </div>
            <div class="track-actions">
              {% if default_player %}
                <form method="get" action="{{ url_for('update_result', track_id=t.id) }}" class="inline">
                  <input type="hidden" name="quick" value="1">
                  <button class="btn" type="submit">I won this one</button>
                </form>
              {% endif %}
              <a class="btn icon" href="{{ url_for('update_result', track_id=t.id) }}" aria-label="Open edit form for {{ t.track_en }}">âœï¸</a>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  </details>
{% endfor %}

{% endblock %}
