{% extends "base.html" %}
{% block body %}

<form method="get" class="totals filter-form">
  <label>
    Owner
    <select id="owner" name="owner">
      <option value="all" {{ "selected" if selected_filters.owner == "all" else "" }}>All</option>
      {% for p in players %}
        <option value="{{ p }}" {{ "selected" if selected_filters.owner == p else "" }}>{{ p }}</option>
      {% endfor %}
    </select>
  </label>
  <label>
    Cup
    <select id="cup" name="cup">
      <option value="all" {{ "selected" if selected_filters.cup == "all" else "" }}>All</option>
      {% for c in cups %}
        <option value="{{ c.code }}" {{ "selected" if selected_filters.cup == c.code else "" }}>
          {{ c.en }} ({{ c.es }})
        </option>
      {% endfor %}
    </select>
  </label>
  <label>
    State
    <select id="state" name="state">
      <option value="any" {{ "selected" if selected_filters.state == "any" else "" }}>Any</option>
      <option value="locked" {{ "selected" if selected_filters.state == "locked" else "" }}>Locked</option>
      <option value="default" {{ "selected" if selected_filters.state == "default" else "" }}>Default</option>
      <option value="at-risk" {{ "selected" if selected_filters.state in ["at-risk","atrisk","at_risk"] else "" }}>At Risk</option>
    </select>
  </label>
  <div class="filter-actions">
    <button class="btn" type="submit">Apply</button>
    <a class="btn" href="{{ url_for('index') }}">Reset</a>
  </div>
  <div class="filter-actions">
    <small style="color:#666;">Need CSV exports? Use the Control Center â˜°.</small>
  </div>
</form>

<div class="totals" style="margin-top:8px;">
  <label style="display:flex;flex-direction:column;gap:4px;">
    Quick search (track or cup)
    <input type="search" id="track-search" placeholder="e.g. Senda Arcoiris / Rainbow Road" style="padding:8px;border-radius:10px;border:1px solid #ccc;">
  </label>
  <small style="color:#555;">Search matches English or Spanish names instantly on this page.</small>
</div>

{% if default_player %}
  <div class="totals" style="background:#e3f2fd;">
    Quick updates enabled for <strong>{{ default_player.name }}</strong>. Set a different default in the Players tab.
  </div>
{% else %}
  <div class="totals">
    Tip: set a default player from the Players tab to unlock the â€œI won this oneâ€ shortcut.
  </div>
{% endif %}

<div class="totals">
  <strong>Tracks owned:</strong>
  {% if not totals_overall %}
    â€”
  {% else %}
    <ol style="margin:.2em 0 0 1.2em;padding:0;">
      {% for pair in totals_overall %}
        {% set p = pair[0] %}
        {% set n = pair[1] %}
        <li style="list-style:none;margin:.1em 0;">
          {% if loop.index0 == 0 %}ğŸ¥‡{% elif loop.index0 == 1 %}ğŸ¥ˆ{% elif loop.index0 == 2 %}ğŸ¥‰{% else %}{{ loop.index }}.{% endif %}
          {{ p }}: {{ n }}
          {% set streak = streaks_by_name.get(p) %}
          {% if streak and streak.current_win_streak >= 2 %}
            ğŸ”¥ {{ streak.current_win_streak }}
          {% endif %}
          {% if streak and streak.current_defense_streak >= 2 %}
            ğŸ›¡ï¸ {{ streak.current_defense_streak }}
          {% endif %}
        </li>
      {% endfor %}
    </ol>
  {% endif %}

  {% set filtering = selected_filters.owner != "all" or selected_filters.cup != "all" or selected_filters.state != "any" %}
  {% if filtering %}
    <br>
    <strong>Filtered tracks owned:</strong>
    {% if not totals_filtered %}
      â€”
    {% else %}
      <ol style="margin:.2em 0 0 1.2em;padding:0;">
        {% for pair in totals_filtered %}
          {% set p = pair[0] %}
          {% set n = pair[1] %}
          <li style="list-style:none;margin:.1em 0;">
            {% if loop.index0 == 0 %}ğŸ¥‡{% elif loop.index0 == 1 %}ğŸ¥ˆ{% elif loop.index0 == 2 %}ğŸ¥‰{% else %}{{ loop.index }}.{% endif %}
            {{ p }}: {{ n }}
            {% set streak = streaks_by_name.get(p) %}
            {% if streak and streak.current_win_streak >= 2 %}
              ğŸ”¥ {{ streak.current_win_streak }}
            {% endif %}
            {% if streak and streak.current_defense_streak >= 2 %}
              ğŸ›¡ï¸ {{ streak.current_defense_streak }}
            {% endif %}
          </li>
        {% endfor %}
      </ol>
    {% endif %}
  {% endif %}
</div>

{% for cup in standings %}
  <details class="cup-panel" open>
    <summary>
      <div class="cup-logo">
        {% if cup.logo_src %}
          <img src="{{ cup.logo_src }}" alt="{{ cup.cup_en }} logo">
        {% else %}
          <div class="cup-logo-placeholder">{{ cup.cup_en[0] }}</div>
        {% endif %}
      </div>
      <div>
        <h2 style="margin:0;">{{ cup.cup_en }} ({{ cup.cup_es }})</h2>
      </div>
    </summary>
    <div class="cup-tracks">
      {% for t in cup.tracks %}
        {% set has_art = t.image_src is not none %}
        <div class="track-card {% if has_art %}has-art{% endif %}" {% if has_art %}style="--track-art: url('{{ t.image_src }}');"{% endif %}>
          <div class="track-thumb-wrapper">
            {% if has_art %}
              <img class="track-thumb" src="{{ t.image_src }}" alt="{{ t.track_en }}">
            {% else %}
              <div class="track-thumb-placeholder">{{ t.track_en[0] }}</div>
            {% endif %}
          </div>
          <div class="track-content">
            <div class="track-names">
              <strong>{{ t.track_en }}</strong>
              <small>{{ t.track_es }}</small>
            </div>
            <div class="owner-line">
              Owner: {{ t.owner or "â€”" }}
            </div>
            <div class="track-state">
              {% if t.state == 1 %}
                <span class="badge badge-locked">ğŸ”’ Locked</span>
              {% elif t.state == -1 %}
                <span class="badge badge-risk">âš ï¸ At risk</span>
                {% if t.threatened_by %}
                  <span class="badge badge-hunter">ğŸ¯ {{ t.threatened_by }}</span>
                {% endif %}
              {% else %}
                <span class="badge badge-default">Default</span>
              {% endif %}
            </div>
            <div class="track-actions">
              {% if default_player %}
                <form method="get" action="{{ url_for('update_result', track_id=t.id) }}" class="inline">
                  <input type="hidden" name="quick" value="1">
                  <button class="btn" type="submit">I won this one</button>
                </form>
              {% endif %}
              <a class="btn icon" href="{{ url_for('update_result', track_id=t.id) }}" aria-label="Open edit form for {{ t.track_en }}">âœï¸</a>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  </details>
{% endfor %}

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const input = document.getElementById('track-search');
    if (!input) return;
    const cards = Array.from(document.querySelectorAll('.track-card'));
    const panels = Array.from(document.querySelectorAll('details.cup-panel'));
    cards.forEach(card => {
      const cupHeading = card.closest('details.cup-panel')?.querySelector('summary h2')?.innerText || '';
      card.dataset.searchText = (cupHeading + ' ' + card.innerText).toLowerCase();
    });
    const applyFilter = () => {
      const term = input.value.trim().toLowerCase();
      cards.forEach(card => {
        const match = !term || card.dataset.searchText.includes(term);
        card.classList.toggle('search-hidden', !match);
      });
      panels.forEach(panel => {
        const visibleTracks = panel.querySelectorAll('.track-card:not(.search-hidden)').length;
        panel.classList.toggle('search-hidden', term && visibleTracks === 0);
      });
    };
    input.addEventListener('input', applyFilter);
    applyFilter();
  });
</script>

{% endblock %}
