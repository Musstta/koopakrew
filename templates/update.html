{% extends "base.html" %}
{% block body %}
<h2>Update Race Result</h2>
<div class="totals">
  <div><strong>{{ track['track_en'] }}</strong> ({{ track['track_es'] }})</div>
  <div>Cup: {{ track['cup_en'] }} ({{ track['cup_es'] }})</div>
  <div>Owner: <strong>{{ track['owner'] or "â€”" }}</strong></div>
  <div>
    State:
    {% if track['state'] == 1 %}<span class="locked">ğŸ”’ Locked</span>
    {% elif track['state'] == -1 %}<span class="risk">âš ï¸ At risk</span>
    {% else %}<span class="normal">Default</span>{% endif %}
  </div>
</div>

{% if prefill_winner %}
  <div class="form-card" style="margin-bottom:16px;background:#f1f8e9;">
    <h3 style="margin-top:0;">Quick confirmation</h3>
    <p>{{ prefill_winner }} is set as your default player{% if default_player %} ({{ default_player.name }}){% endif %}. Confirm this win?</p>
    <form method="post" style="display:flex;flex-direction:column;gap:12px;">
      <input type="hidden" name="winner" value="{{ prefill_winner }}">
      <div class="filter-actions">
        <button class="btn" type="submit">Yes, save it</button>
        <a class="btn" href="{{ url_for('update_result', track_id=track['id']) }}">Choose another winner</a>
      </div>
    </form>
  </div>
{% endif %}

<div class="form-card">
  <h3 style="margin-top:0;">Manual update</h3>
  <form method="post">
    <label for="winner">Winner</label>
    <select name="winner" id="winner" required>
      {% for p in players %}
        <option value="{{ p }}"
          {% if prefill_winner and p == prefill_winner %}
            selected
          {% elif not prefill_winner and p == track['owner'] %}
            selected
          {% endif %}>
          {{ p }}
        </option>
      {% endfor %}
    </select>
    <div class="filter-actions">
      <button class="btn" type="submit">Save</button>
      <a class="btn" href="{{ url_for('index') }}">Cancel</a>
    </div>
  </form>
</div>

{% if recent_events %}
  <h3>Recent history</h3>
  <ul>
    {% for ev in recent_events %}
      <li class="event-detail">
        {{ ev['occurred_at'] }} â€”
        Winner: {{ ev['winner_name'] or "â€”" }}.
        Before: {{ ev['pre_owner_name'] or "â€”" }}
        {% if ev['pre_state'] == 1 %}(Locked){% elif ev['pre_state'] == -1 %}(At risk){% elif ev['pre_state'] == 0 %}(Default){% endif %};
        After: {{ ev['post_owner_name'] or "â€”" }}
        {% if ev['post_state'] == 1 %}(Locked){% elif ev['post_state'] == -1 %}(At risk){% elif ev['post_state'] == 0 %}(Default){% endif %}.
      </li>
    {% endfor %}
  </ul>
{% endif %}
{% endblock %}
